<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WMS Berbasis QR Code</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- QR CODE LIBRARY: qrcode.js untuk menghasilkan QR Code -->
    <!-- URL: https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Custom styles for better mobile visibility */
        .scan-input {
            font-size: 1.25rem;
            padding: 0.75rem;
            text-transform: uppercase;
        }
        .transaction-card {
            /* Menyesuaikan min-height agar tidak terlalu panjang di mobile */
            min-height: auto; 
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 1000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        /* Style for barcode container */
        .qrcode-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 120px;
            padding: 1rem 0;
            background-color: #fff;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        /* Kontainer untuk menahan gambar QR Code */
        #qrcode-render-target { /* Diperbarui ID */
            padding: 1rem;
        }

        .barcode-display-copy {
            font-family: monospace;
            font-size: 1.2rem;
            letter-spacing: 2px;
            margin-top: 10px;
            padding: 5px;
            border: 1px dashed #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
            user-select: all; /* Memudahkan seleksi */
        }

        /* PERBAIKAN MOBILE: Memastikan tombol navigasi tidak berantakan */
        .nav-menu-wrapper {
            /* Memastikan menu wrap di mobile */
            flex-wrap: wrap; 
            justify-content: space-around;
        }
        .nav-btn {
            /* Memastikan tombol menu memiliki margin yang pas di mobile */
            margin: 0.25rem; 
            flex-grow: 1; 
            text-align: center;
            /* Ukuran font lebih kecil di mobile */
            font-size: 0.875rem; 
            padding: 0.5rem 0.25rem; 
        }

        /* Memastikan padding di main content tetap nyaman */
        main {
            padding: 1rem;
        }

        @media (min-width: 768px) {
            .nav-btn {
                font-size: 1rem;
                padding: 0.75rem 1rem;
            }
            main {
                padding: 2rem;
            }
            .transaction-card {
                 min-height: 400px; 
            }
        }
        
        /* ======================================= */
        /* CSS KHUSUS PRINT (Cetak) */
        /* ======================================= */
        @media print {
            /* Sembunyikan semua elemen UI utama */
            body > *:not(.print-area),
            .print-hidden {
                display: none !important;
            }
            /* Tampilkan area cetak */
            .print-area {
                display: block !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                /* Reset margin/padding agar stiker/label tercetak dengan baik */
                padding: 0;
                margin: 0;
                box-shadow: none;
            }
            /* Aturan untuk label sederhana */
            #print-content {
                display: flex;
                flex-direction: column;
                align-items: center;
                text-align: center;
                width: 100%;
                padding: 10px;
                box-sizing: border-box;
            }
            /* Pastikan QR Code rata tengah saat dicetak */
            .qrcode-container {
                border: none;
                justify-content: center; 
            }

            /* FIX KRITIS: Memastikan CANVAS/IMAGE yang dikloning terlihat */
            .print-area img, .print-area canvas {
                display: block !important;
            }
        }
    </style>
</head>
<body>

    <div id="app" class="min-h-screen flex flex-col">

        <!-- Header -->
        <header class="bg-gray-800 text-white shadow-lg p-4 sticky top-0 z-10 print-hidden">
            <h1 class="text-2xl font-bold">Smart WMS QR Code</h1>
            <p id="auth-status" class="text-sm text-gray-400 mt-1">Status: Terhubung (Publik)</p>
        </header>

        <!-- Loading Overlay -->
        <div id="loading-spinner" class="loading-overlay print-hidden" style="display: none;">
            <div class="flex flex-col items-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-indigo-600"></div>
                <p class="mt-3 text-lg font-semibold text-gray-700">Memuat data gudang...</p>
            </div>
        </div>

        <!-- Main Content (Container) -->
        <main class="flex-grow p-4 md:p-8">

            <!-- Navigation / Menu Tabs (PERBAIKAN: Menggunakan nav-menu-wrapper dan flex-wrap) -->
            <div class="nav-menu-wrapper flex justify-center space-x-2 md:space-x-4 mb-6 sticky top-16 bg-white p-3 rounded-xl shadow-md z-10 print-hidden">
                <button onclick="changeView('dashboard')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Dashboard</button>
                <button onclick="changeView('search')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Cari</button>
                <button onclick="changeView('sku-register')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Registrasi SKU</button>
                <button onclick="changeView('receive')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Penerimaan</button>
                <button onclick="changeView('move')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Perpindahan</button>
                <button onclick="changeView('pick')" class="nav-btn p-3 rounded-lg font-semibold transition duration-150 ease-in-out">Pengambilan</button>
            </div>

            <!-- View Sections -->
            <div id="views-container">
                <!-- Dashboard View -->
                <div id="dashboard-view" class="view-section hidden">
                    <h2 class="text-3xl font-bold text-gray-800 mb-6">Ringkasan Inventaris</h2>
                    
                    <!-- GRID STATS: Sudah responsive (grid-cols-1 di mobile, grid-cols-3 di desktop) -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                        <div class="bg-indigo-600 text-white p-6 rounded-xl shadow-lg">
                            <p class="text-sm opacity-90">Total SKU Unik</p>
                            <p id="total-sku" class="text-4xl font-extrabold mt-1">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <p class="text-sm text-gray-500">Total Stok Unit</p>
                            <p id="total-qty" class="text-4xl font-extrabold text-gray-800 mt-1">0</p>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                            <p class="text-sm text-gray-500">Lokasi Aktif</p>
                            <p id="total-locations" class="text-4xl font-extrabold text-gray-800 mt-1">0</p>
                        </div>
                    </div>

                    <h3 class="text-xl font-semibold text-gray-700 mb-4">Detail Inventaris (Semua Lokasi)</h3>
                    <!-- PERBAIKAN: overflow-x-auto agar tabel bisa di-scroll horizontal di mobile -->
                    <div class="bg-white rounded-xl shadow-lg overflow-x-auto"> 
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th> <!-- FIX: Jumlah (Stok) digeser ke sini -->
                                    <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Diperbarui</th> <!-- FIX: Diperbarui (Waktu) digeser ke sini -->
                                </tr>
                            </thead>
                            <tbody id="inventory-list" class="bg-white divide-y divide-gray-200">
                                <!-- Data inventaris akan dimasukkan di sini oleh JS -->
                            </tbody>
                        </table>
                        <div id="empty-inventory" class="p-4 text-center text-gray-500" style="display: none;">
                            Inventaris kosong. Silakan mulai Penerimaan.
                        </div>
                    </div>
                </div>
                
                <!-- Search View -->
                <div id="search-view" class="view-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl transaction-card">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Pencarian Inventaris</h2>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">Cari berdasarkan SKU, Lokasi, atau Deskripsi</label>
                            <input type="text" id="search-input" 
                                class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" 
                                placeholder="Masukkan SKU atau Lokasi (Cth: ABC-001 atau A1B2)" 
                                oninput="searchInventory()">
                        </div>

                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Hasil Pencarian</h3>
                         <div class="bg-white rounded-xl shadow-lg overflow-x-auto border"> 
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">SKU</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Deskripsi</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                        <th class="px-3 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Jumlah</th>
                                    </tr>
                                </thead>
                                <tbody id="search-results-list" class="bg-white divide-y divide-gray-200">
                                    <!-- Hasil pencarian akan dimasukkan di sini oleh JS -->
                                </tbody>
                            </table>
                            <div id="empty-search" class="p-4 text-center text-gray-500">
                                Mulai ketik untuk mencari inventaris...
                            </div>
                        </div>
                    </div>
                </div>

                <!-- SKU Register View -->
                <div id="sku-register-view" class="view-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl transaction-card">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Registrasi SKU & QR Code</h2>
                        
                        <div class="mb-6">
                            <label class="block text-gray-700 font-semibold mb-2">1. Masukkan Kode SKU Baru (Wajib)</label>
                            <input type="text" id="register-sku-code" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Cth: PRODUK-ABC-001">

                            <label class="block text-gray-700 font-semibold mb-2">2. Deskripsi/Nama Produk</label>
                            <input type="text" id="register-sku-desc" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 mb-6" placeholder="Cth: Minuman Kaleng Rasa Jeruk">
                            
                            <button onclick="registerSku()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Daftarkan SKU Baru</button>
                        </div>

                        <div id="register-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>

                        <hr class="my-8">

                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Cetak QR Code (SKU Terdaftar)</h3>
                        <div class="bg-gray-50 p-6 rounded-xl border border-gray-200">
                            <label class="block text-gray-700 font-semibold mb-2">Kode SKU</label>
                            <input type="text" id="barcode-print-sku" class="w-full border border-gray-300 rounded-lg p-3 focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Masukkan SKU untuk dicetak">
                            
                            <button onclick="generateBarcode(false)" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg transition duration-150 mb-4">Tampilkan QR Code</button>
                            
                            <div id="barcode-output" class="text-center mt-4 hidden print-area">
                                
                                <div id="print-content">
                                    <p class="text-sm text-gray-500 mb-2 print-hidden">VISUAL (QR CODE DAPAT DI-SCAN):</p>
                                    <div class="qrcode-container">
                                        <div id="qrcode-div-display-placeholder"></div> <!-- NEW PLACEHOLDER -->
                                    </div>
    
                                    <p id="print-sku-title" class="barcode-code text-gray-900 font-bold mt-2 text-lg"></p>
                                    <p id="print-sku-desc" class="barcode-code text-gray-600 text-sm mb-4"></p>
                                    
                                    <!-- TOMBOL CETAK DENGAN FUNGSI window.print() -->
                                    <button onclick="printQR()" class="mt-4 w-4/5 bg-gray-700 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition duration-150 print-hidden">Cetak QR Code Ini</button>

                                    <p class="text-sm text-gray-500 mt-4 mb-2 print-hidden">TEKS YANG DIHASILKAN (KLIK UNTUK SALIN & SIMULASI SCAN):</p>
                                    <div id="barcode-text-display" class="barcode-display-copy select-all print-hidden" onclick="copyBarcode(this)"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Transaction Views -->
                <div id="receive-view" class="view-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl transaction-card">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Penerimaan Barang (IN)</h2>
                        <div id="receive-step-1">
                            <label class="block text-gray-700 font-semibold mb-2">1. Pindai/Masukkan QR Code SKU (Wajib Terdaftar)</label>
                            <input type="text" id="receive-sku-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="SKU QR Code" onkeypress="handleReceiveKeyPress(event)">
                            <button onclick="startReceiveStep2()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Lanjut</button>
                        </div>
                        <div id="receive-step-2" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">SKU: <span id="current-receive-sku" class="font-bold text-indigo-600"></span></label>
                            <label class="block text-gray-700 font-semibold mb-2">2. Pindai/Masukkan QR Code Lokasi (Cth: A1B2)</label>
                            <input type="text" id="receive-location-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Lokasi QR Code" onkeypress="handleReceiveKeyPress(event)">
                            <label class="block text-gray-700 font-semibold mb-2">3. Masukkan Kuantitas Diterima</label>
                            <input type="number" id="receive-qty-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-6" placeholder="Kuantitas" value="1" min="1">
                            <button onclick="commitReceive()" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Simpan Penerimaan</button>
                            <button onclick="resetReceive()" class="w-full mt-3 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Batalkan</button>
                        </div>
                        <div id="receive-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
                    </div>
                </div>

                <div id="move-view" class="view-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl transaction-card">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Perpindahan Barang (MOVE)</h2>
                        <div id="move-step-1">
                            <label class="block text-gray-700 font-semibold mb-2">1. Pindai/Masukkan QR Code SKU</label>
                            <input type="text" id="move-sku-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="SKU QR Code" onkeypress="handleMoveKeyPress(event)">
                            <button onclick="startMoveStep2()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Lanjut</button>
                        </div>
                         <div id="move-step-2" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">SKU: <span id="current-move-sku" class="font-bold text-indigo-600"></span></label>
                            <label class="block text-gray-700 font-semibold mb-2">2. Pindai/Masukkan Lokasi ASAL</label>
                            <input type="text" id="move-from-location-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Lokasi Asal" onkeypress="handleMoveKeyPress(event)">
                            <button onclick="startMoveStep3()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Lanjut</button>
                        </div>
                        <div id="move-step-3" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">3. Pindai/Masukkan Lokasi TUJUAN</label>
                            <input type="text" id="move-to-location-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Lokasi Tujuan" onkeypress="handleMoveKeyPress(event)">
                            <label class="block text-gray-700 font-semibold mb-2">4. Masukkan Kuantitas Dipindahkan</label>
                            <input type="number" id="move-qty-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-6" placeholder="Kuantitas" value="1" min="1">
                            <button onclick="commitMove()" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Simpan Perpindahan</button>
                            <button onclick="resetMove()" class="w-full mt-3 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Batalkan</button>
                        </div>
                        <div id="move-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
                    </div>
                </div>

                <div id="pick-view" class="view-section hidden">
                    <div class="bg-white p-6 md:p-10 rounded-xl shadow-xl transaction-card">
                        <h2 class="text-3xl font-bold text-gray-800 mb-6">Pengambilan Barang (OUT)</h2>
                        <div id="pick-step-1">
                            <label class="block text-gray-700 font-semibold mb-2">1. Pindai/Masukkan QR Code SKU</label>
                            <input type="text" id="pick-sku-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="SKU QR Code" onkeypress="handlePickKeyPress(event)">
                            <button onclick="startPickStep2()" class="w-full bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Lanjut</button>
                        </div>
                        <div id="pick-step-2" class="hidden">
                            <label class="block text-gray-700 font-semibold mb-2">SKU: <span id="current-pick-sku" class="font-bold text-indigo-600"></span></label>
                            <label class="block text-gray-700 font-semibold mb-2">2. Pindai/Masukkan QR Code Lokasi Pengambilan</label>
                            <input type="text" id="pick-location-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-4" placeholder="Lokasi QR Code" onkeypress="handlePickKeyPress(event)">
                            <label class="block text-gray-700 font-semibold mb-2">3. Masukkan Kuantitas Diambil</label>
                            <input type="number" id="pick-qty-input" class="scan-input w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 mb-6" placeholder="Kuantitas" value="1" min="1">
                            <button onclick="commitPick()" class="w-full bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg transition duration-150">Simpan Pengambilan</button>
                            <button onclick="resetPick()" class="w-full mt-3 bg-gray-400 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg transition duration-150">Batalkan</button>
                        </div>
                        <div id="pick-message" class="mt-4 p-3 rounded-lg text-center font-medium hidden"></div>
                    </div>
                </div>

            </div>
        </main>

        <!-- Footer -->
        <footer class="p-4 text-center text-sm text-gray-600 border-t mt-8 print-hidden">
            WMS Sederhana - Didukung oleh Firestore Real-time
        </footer>

    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js"; 
        import { getFirestore, collection, query, onSnapshot, doc, setDoc, runTransaction, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level for debugging
        setLogLevel('debug');

        // =================================================================
        // KONFIGURASI FIREBASE (PUBLIC)
        // =================================================================
        
        // Konfigurasi Firebase Web Client yang valid dari pengguna
        const firebaseConfig = {
            apiKey: "AIzaSyBlpx1lUsog0fbGtu73fWLpT2I6k0bh9CA",
            authDomain: "wms01-b45c5.firebaseapp.com",
            projectId: "wms01-b45c5",
            storageBucket: "wms01-b45c5.firebasestorage.app",
            messagingSenderId: "490608373871",
            appId: "1:490608373871:web:0f2b44ba99b5fa75a55d9a",
            measurementId: "G-BH7664FPDG"
        };
        
        // Firebase Initialization and Services
        let app;
        let db;
        
        // userId tidak diperlukan karena tidak ada otentikasi. Kita akan menggunakan ID statis.
        const userId = 'PUBLIC_USER'; 

        // Application State
        window.currentView = 'dashboard';
        window.inventory = [];
        window.skuMaster = {}; // NEW: Storage for registered SKUs
        window.currentUser = null;

        // Path Collection Disederhanakan untuk deployment eksternal.
        const INVENTORY_COLLECTION = `wms_inventory`; 
        const SKU_MASTER_COLLECTION = `wms_sku_master`; // NEW: Master SKU Collection
        
        // --- Utility Functions ---

        /**
         * Simulates an asynchronous delay (for API call simulation/backoff).
         */
        const delay = ms => new Promise(resolve => setTimeout(resolve, ms));

        /**
         * Shows a temporary status message in the UI.
         */
        function showMessage(elementId, message, type = 'success') {
            const el = document.getElementById(elementId);
            if (!el) return;

            el.textContent = message;
            el.className = 'mt-4 p-3 rounded-lg text-center font-medium transition duration-300 block';

            if (type === 'success') {
                el.classList.add('bg-green-100', 'text-green-800');
            } else if (type === 'error') {
                el.classList.add('bg-red-100', 'text-red-800');
            } else if (type === 'info') {
                el.classList.add('bg-blue-100', 'text-blue-800');
            }
            
            // Hide after 4 seconds
            setTimeout(() => {
                el.classList.add('hidden');
            }, 4000);
        }

        /**
         * Toggles the loading spinner display.
         */
        function toggleLoading(show) {
            document.getElementById('loading-spinner').style.display = show ? 'flex' : 'none';
        }
        
        /**
         * Generates the scannable Code 39 simulation string (*SKU-CODE*).
         * NOTE: Karena kita menggunakan QR Code, kita tidak perlu karakter start/stop (*).
         * @param {string} text The SKU code.
         * @returns {string} The raw SKU text.
         */
        function generateCode39Simulation(text) {
            // Untuk QR Code, kita cukup menggunakan teks mentah.
            return text;
        }


        // --- Firebase Core Functions ---

        /**
         * Initializes Firebase and starts listening to data.
         */
        async function initFirebase() {
            try {
                
                // Inisialisasi tanpa Auth
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                
                // Mulai mendengarkan Inventaris dan SKU Master
                setupInventoryListener();
                setupSkuMasterListener();

            } catch (error) {
                console.error("Error saat inisialisasi Firebase:", error);
                document.getElementById('auth-status').textContent = `Status: Error - ${error.message}`;
            }
        }
        
        /**
         * Sets up real-time listener for the SKU Master collection.
         */
        function setupSkuMasterListener() {
            if (!db) return;

            const q = query(collection(db, SKU_MASTER_COLLECTION));
            
            onSnapshot(q, (snapshot) => {
                window.skuMaster = {};
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    window.skuMaster[doc.id] = data;
                });
                console.log("SKU Master Diperbarui:", Object.keys(window.skuMaster).length, "SKU terdaftar.");
                
                // FIX KRITIS: Panggil renderDashboard untuk memperbarui Total SKU Unik
                renderDashboard(); 
                
            }, (error) => {
                console.error("Error saat mendapatkan snapshot SKU Master:", error);
                // Menambahkan pesan error visual jika Listener SKU Master gagal
                showMessage('auth-status', 'Gagal memuat Master SKU. (Cek Rule Firestore: wms_sku_master)', 'error');
            });
        }

        /**
         * Sets up real-time listener for the public inventory collection.
         */
        function setupInventoryListener() {
            if (!db) {
                console.error("Firestore belum diinisialisasi.");
                return;
            }

            const q = query(collection(db, INVENTORY_COLLECTION));
            toggleLoading(true);

            onSnapshot(q, (snapshot) => {
                window.inventory = [];
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    window.inventory.push({ id: doc.id, ...data });
                });
                console.log("Inventaris Diperbarui:", window.inventory.length, "dokumen.");
                renderDashboard();
                toggleLoading(false);
            }, (error) => {
                console.error("Error saat mendapatkan snapshot inventaris:", error);
                toggleLoading(false);
                // Pesan peringatan yang jelas untuk pengguna publik
                showMessage('auth-status', 'Gagal memuat inventaris real-time. (Cek Rule Firestore Anda)', 'error');
            });
        }

        // --- Inventory DB Operations (Firestore Transaction) ---

        /**
         * Handles the core transaction logic for adding or removing stock.
         * @param {string} sku - Product SKU.
         * @param {string} location - Warehouse location.
         * @param {number} qtyChange - Positive for add, negative for remove.
         * @returns {Promise<boolean>} Success status.
         */
        async function updateInventoryTransaction(sku, location, qtyChange) {
            if (qtyChange === 0) return true; // No change needed

            const formattedSKU = sku.toUpperCase();
            const formattedLocation = location.toUpperCase();
            const documentId = `${formattedSKU}_${formattedLocation}`;
            const docRef = doc(db, INVENTORY_COLLECTION, documentId);
            
            let success = false;
            let finalQty = 0;

            try {
                await runTransaction(db, async (transaction) => {
                    const docSnapshot = await transaction.get(docRef);
                    let currentQty = 0;

                    if (docSnapshot.exists()) {
                        currentQty = docSnapshot.data().qty || 0;
                    }

                    finalQty = currentQty + qtyChange;
                    
                    // Validation for picking/moving out (must not result in negative stock)
                    if (qtyChange < 0 && finalQty < 0) {
                        throw new Error(`Stok tidak cukup. Stok saat ini ${currentQty} di ${formattedLocation}. Permintaan ${-qtyChange}.`);
                    }

                    const timestamp = new Date().toISOString();

                    if (finalQty > 0) {
                        // Update or Set the document
                        transaction.set(docRef, {
                            sku: formattedSKU,
                            location: formattedLocation,
                            qty: finalQty,
                            updatedBy: userId,
                            updatedAt: timestamp
                        });
                    } else {
                        // If quantity is 0, delete the document
                        transaction.delete(docRef);
                    }
                    
                    success = true;
                });
            } catch (error) {
                console.error("Error dalam Transaksi:", error);
                // Tambahkan penanganan izin khusus untuk pengguna publik
                if (error.code === 'PERMISSION_DENIED') {
                    throw new Error("Gagal: Izin ditolak. Pastikan Aturan Keamanan Firestore Anda diatur ke 'allow read, write: if true;'.");
                }
                throw error; // Re-throw to be caught by the calling function
            }
            return success;
        }
        
        // --- SKU MASTER Functions ---
        
        window.registerSku = async function() {
            const skuInput = document.getElementById('register-sku-code');
            const descInput = document.getElementById('register-sku-desc');
            const skuCode = skuInput.value.trim().toUpperCase();
            const skuDesc = descInput.value.trim();
            const messageEl = 'register-message';

            if (!skuCode || !skuDesc) {
                showMessage(messageEl, 'SKU Code dan Deskripsi wajib diisi.', 'error');
                return;
            }

            if (window.skuMaster[skuCode]) {
                showMessage(messageEl, `SKU ${skuCode} sudah terdaftar.`, 'error');
                return;
            }
            
            showMessage(messageEl, 'Mendaftarkan SKU...', 'info');

            try {
                const docRef = doc(db, SKU_MASTER_COLLECTION, skuCode);
                const dataToSave = { // Tangkap data yang akan disimpan
                    code: skuCode,
                    description: skuDesc,
                    createdAt: new Date().toISOString(),
                    createdBy: userId
                };
                await setDoc(docRef, dataToSave);
                
                // FIX: Update local master list IMMEDIATELY setelah sukses menyimpan.
                // Ini memastikan generateBarcode bisa melihat data baru tanpa menunggu listener.
                window.skuMaster[skuCode] = dataToSave;
                
                showMessage(messageEl, `SKU ${skuCode} berhasil didaftarkan!`, 'success');
                skuInput.value = '';
                descInput.value = '';
                skuInput.focus();
            } catch (e) {
                showMessage(messageEl, `Gagal mendaftarkan SKU: ${e.message}`, 'error');
            }
        };

        window.generateBarcode = async function(shouldPrint = false) {
            const skuInput = document.getElementById('barcode-print-sku');
            const skuCode = skuInput.value.trim().toUpperCase();
            const outputEl = document.getElementById('barcode-output');
            const qrcodeContainerEl = document.querySelector('.qrcode-container'); // Container utama
            const textEl = document.getElementById('barcode-text-display');
            
            const skuTitleEl = document.getElementById('print-sku-title');
            const skuDescEl = document.getElementById('print-sku-desc');
            const printButtonEl = document.querySelector('#barcode-output button');


            if (!skuCode) {
                outputEl.classList.add('hidden');
                showMessage('register-message', 'Masukkan SKU yang ingin Anda cetak.', 'error');
                return;
            }

            // Cek apakah SKU terdaftar
            const skuData = window.skuMaster[skuCode];
            if (!skuData) {
                 outputEl.classList.add('hidden');
                 showMessage('register-message', `SKU ${skuCode} belum terdaftar di sistem.`, 'error');
                 return;
            }
            
            const scannableCode = generateCode39Simulation(skuCode);
            
            if(printButtonEl) printButtonEl.disabled = true;

            // FIX KRITIS: Ganti elemen lama dengan elemen baru untuk rendering yang bersih
            
            // 1. Hapus placeholder lama
            let oldPlaceholder = document.getElementById('qrcode-div-display-placeholder');
            if (oldPlaceholder) {
                qrcodeContainerEl.removeChild(oldPlaceholder);
            }

            // 2. Buat elemen DIV baru yang benar-benar bersih untuk target qrcode.js
            const newPlaceholder = document.createElement('div');
            newPlaceholder.id = 'qrcode-div-display-placeholder'; // Beri ID baru
            qrcodeContainerEl.appendChild(newPlaceholder);

            // 3. RENDER QR CODE MENGGUNAKAN qrcode.js
            try {
                new QRCode(newPlaceholder, { // Targetkan elemen baru
                    text: scannableCode,
                    width: 128,
                    height: 128,
                    colorDark : "#000000",
                    colorLight : "#ffffff",
                    correctLevel : QRCode.CorrectLevel.H
                });
            } catch (e) {
                console.error("QRCode Gagal Render:", e);
                newPlaceholder.innerHTML = '<p class="text-red-500">Gagal Render QR Code.</p>';
                showMessage('register-message', 'Gagal membuat QR Code visual. Periksa konsol untuk detail.', 'error');
                if(printButtonEl) printButtonEl.disabled = false;
                return;
            }
            
            // --- NEW FIX: Convert Canvas to static Image for Print Reliability ---
            // 4. FIX DELAY: Tunggu lebih lama (500ms) agar elemen canvas/image selesai digambar
            await delay(500); // Ditingkatkan menjadi 500ms
            
            // Ambil elemen canvas yang baru digambar
            const canvas = newPlaceholder.querySelector('canvas');
            
            if (canvas) {
                // Konversi canvas menjadi Data URL (Base64)
                const dataURL = canvas.toDataURL('image/png');
                
                // Buat elemen <img> statis
                const printImg = document.createElement('img');
                printImg.src = dataURL;
                printImg.alt = "QR Code";
                printImg.style.width = '128px'; 
                printImg.style.height = '128px';
                
                // Tambahkan kelas print-area agar CSS media query bisa menangkapnya
                printImg.classList.add('print-area-image'); 

                // Ganti elemen placeholder dengan gambar statis
                newPlaceholder.innerHTML = ''; 
                newPlaceholder.appendChild(printImg);
            }
            // --- END NEW FIX ---

            // 5. Tampilkan data
            textEl.textContent = scannableCode; 
            skuTitleEl.textContent = skuCode; 
            skuDescEl.textContent = skuData.description;

            outputEl.classList.remove('hidden');

            // 6. LOGIKA DELAY CETAK
            if(shouldPrint) {
                // Berikan jeda waktu 700ms setelah konversi untuk memastikan browser menangkap <img>
                setTimeout(() => {
                    // METHOD BARU: Cetak DOM Element
                    printDomElement(document.getElementById('print-content'));
                    if(printButtonEl) printButtonEl.disabled = false;
                }, 700); 
            } else {
                if(printButtonEl) printButtonEl.disabled = false;
            }
        };
        
        // =================================================================
        // FUNGSI BARU: MENCETAK ELEMEN DOM SECARA LANGSUNG
        // =================================================================
        function printDomElement(element) {
            const printWindow = window.open('', '', 'height=600,width=800');
            printWindow.document.write('<html><head><title>Cetak QR Code</title>');
            // Salin CSS yang diperlukan untuk cetak
            printWindow.document.write('<style>@media print { body { padding: 0; margin: 0; } #print-area-temp { display: flex; flex-direction: column; align-items: center; text-align: center; width: 100%; padding: 10px; box-sizing: border-box; } #print-area-temp img { display: block; margin: 10px auto; } p { font-family: "Inter", sans-serif; } }</style>');
            printWindow.document.write('</head><body>');
            
            // Kloning konten cetak
            const clonedContent = element.cloneNode(true);
            
            // Hapus tombol dan elemen yang tidak perlu dicetak
            clonedContent.querySelector('.print-hidden').style.display = 'none'; // Sembunyikan tombol cetak
            clonedContent.querySelector('.barcode-display-copy').style.display = 'none'; // Sembunyikan teks scannable
            clonedContent.querySelector('#print-sku-title').classList.remove('print-hidden'); 
            clonedContent.querySelector('#print-sku-desc').classList.remove('print-hidden');

            // Hapus teks "VISUAL (QR CODE DAPAT DI-SCAN):"
            const visualText = clonedContent.querySelector('.qrcode-container').previousElementSibling;
            if(visualText && visualText.textContent.includes('VISUAL')) {
                visualText.style.display = 'none';
            }
            
            // Bungkus konten di div temporer
            const wrapper = printWindow.document.createElement('div');
            wrapper.id = 'print-area-temp';
            wrapper.appendChild(clonedContent);
            printWindow.document.body.appendChild(wrapper);

            printWindow.document.write('</body></html>');
            
            // Tunggu sedikit sebelum mencetak
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 50); // Delay kecil sebelum cetak
        }
        
        window.printQR = function() {
            // Panggil generateBarcode lagi, tetapi kali ini dengan flag 'shouldPrint' true
            window.generateBarcode(true);
        };


        window.copyBarcode = function(el) {
            // Salin teks scannable code yang terlihat (SKU mentah)
            const textToCopy = el.textContent; 
            try {
                // Metode modern yang lebih reliable (untuk lingkungan yang support)
                navigator.clipboard.writeText(textToCopy);
                showMessage('register-message', `Kode Scannable (${textToCopy}) berhasil disalin!`, 'success');
            } catch (err) {
                // Fallback untuk iFrame/lingkungan terbatas
                console.error('Gagal menyalin menggunakan navigator.clipboard:', err);
                const textArea = document.createElement("textarea");
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    showMessage('register-message', `Kode Scannable (${textToCopy}) berhasil disalin! (Fallback)`, 'success');
                } catch (err) {
                    showMessage('register-message', 'Gagal menyalin kode. Silakan salin manual.', 'error');
                }
                document.body.removeChild(textArea);
            }
        };


        // --- Core WMS Logic (Receive, Move, Pick) ---

        // ------------------ RECEIVE ------------------

        let receiveState = {
            sku: null,
            location: null,
            qty: null
        };

        window.startReceiveStep2 = function() {
            const skuInput = document.getElementById('receive-sku-input');
            let sku = skuInput.value.trim().toUpperCase();

            // PENGOLAHAN INPUT: Tidak perlu menghapus *
            
            if (!sku) {
                showMessage('receive-message', 'Masukkan QR Code SKU yang valid.', 'error');
                skuInput.focus();
                return;
            }
            
            // NEW VALIDATION: Check if SKU is registered in the master list
            if (!window.skuMaster[sku]) {
                 showMessage('receive-message', `SKU ${sku} belum terdaftar! Silakan daftarkan di tab Registrasi SKU.`, 'error');
                 skuInput.focus();
                 return;
            }

            receiveState.sku = sku;
            document.getElementById('current-receive-sku').textContent = sku;
            
            document.getElementById('receive-step-1').classList.add('hidden');
            document.getElementById('receive-step-2').classList.remove('hidden');
            document.getElementById('receive-location-input').focus();
            document.getElementById('receive-message').classList.add('hidden');
        };
        
        window.commitReceive = async function() {
            const location = document.getElementById('receive-location-input').value.trim().toUpperCase();
            const qty = parseInt(document.getElementById('receive-qty-input').value, 10);

            if (!location || qty <= 0 || !receiveState.sku) {
                showMessage('receive-message', 'Lengkapi SKU, Lokasi, dan Kuantitas (>0).', 'error');
                return;
            }

            showMessage('receive-message', 'Memproses penerimaan...', 'info');

            try {
                await updateInventoryTransaction(receiveState.sku, location, qty);
                showMessage('receive-message', `Sukses! ${qty} unit SKU ${receiveState.sku} diterima di ${location}.`, 'success');
                resetReceive();
            } catch (e) {
                showMessage('receive-message', `Gagal: ${e.message}`, 'error');
            }
        };

        window.resetReceive = function() {
            receiveState = { sku: null, location: null, qty: null };
            document.getElementById('receive-sku-input').value = '';
            document.getElementById('receive-location-input').value = '';
            document.getElementById('receive-qty-input').value = '1';

            document.getElementById('receive-step-1').classList.remove('hidden');
            document.getElementById('receive-step-2').classList.add('hidden');
            document.getElementById('receive-sku-input').focus();
        };

        window.handleReceiveKeyPress = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (document.getElementById('receive-step-1').classList.contains('hidden')) {
                    if (document.activeElement.id === 'receive-qty-input') {
                        commitReceive();
                    } else if (document.activeElement.id === 'receive-location-input') {
                        document.getElementById('receive-qty-input').focus();
                    }
                } else {
                    startReceiveStep2();
                }
            }
        };


        // ------------------ MOVE ------------------

        let moveState = {
            sku: null,
            fromLocation: null,
            toLocation: null,
            qty: null
        };

        window.startMoveStep2 = function() {
            const skuInput = document.getElementById('move-sku-input');
            let sku = skuInput.value.trim().toUpperCase();
            
            // PENGOLAHAN INPUT: Tidak perlu menghapus *
            
            if (!sku) {
                showMessage('move-message', 'Masukkan QR Code SKU yang valid.', 'error');
                skuInput.focus();
                return;
            }
            
            // Check if SKU exists in inventory
            const exists = window.inventory.some(item => (item.sku || '') === sku && item.qty > 0);
            if (!exists) {
                 showMessage('move-message', `SKU ${sku} tidak ditemukan di gudang (atau stok 0).`, 'error');
                 return;
            }
            
            // NEW VALIDATION: Check if SKU is registered in the master list
            if (!window.skuMaster[sku]) {
                 showMessage('move-message', `SKU ${sku} tidak terdaftar. Cek Registrasi SKU.`, 'error');
                 skuInput.focus();
                 return;
            }

            moveState.sku = sku;
            document.getElementById('current-move-sku').textContent = sku;
            
            document.getElementById('move-step-1').classList.add('hidden');
            document.getElementById('move-step-2').classList.remove('hidden');
            document.getElementById('move-from-location-input').focus();
            document.getElementById('move-message').classList.add('hidden');
        };
        
        window.startMoveStep3 = function() {
            const fromLocation = document.getElementById('move-from-location-input').value.trim().toUpperCase();

            if (!fromLocation) {
                showMessage('move-message', 'Masukkan Lokasi ASAL yang valid.', 'error');
                document.getElementById('move-from-location-input').focus();
                return;
            }
            
            // Check if stock exists at this location
            const currentStock = window.inventory.find(item => (item.sku || '') === moveState.sku && (item.location || '') === fromLocation);
            if (!currentStock || currentStock.qty <= 0) {
                 showMessage('move-message', `SKU ${moveState.sku} tidak memiliki stok di Lokasi ${fromLocation}.`, 'error');
                 document.getElementById('move-from-location-input').focus();
                 return;
            }

            moveState.fromLocation = fromLocation;
            
            document.getElementById('move-step-2').classList.add('hidden');
            document.getElementById('move-step-3').classList.remove('hidden');
            document.getElementById('move-to-location-input').focus();
            document.getElementById('move-message').classList.add('hidden');
        };

        window.commitMove = async function() {
            const toLocation = document.getElementById('move-to-location-input').value.trim().toUpperCase();
            const qty = parseInt(document.getElementById('move-qty-input').value, 10);

            if (!toLocation || qty <= 0 || !moveState.fromLocation || !moveState.sku) {
                showMessage('move-message', 'Lengkapi semua langkah dengan benar.', 'error');
                return;
            }
            
            if (moveState.fromLocation === toLocation) {
                 showMessage('move-message', 'Lokasi Asal dan Tujuan tidak boleh sama.', 'error');
                 return;
            }

            showMessage('move-message', `Memproses perpindahan ${moveState.sku} dari ${moveState.fromLocation} ke ${toLocation}...`, 'info');

            try {
                // Step 1: Reduce stock from FROM location (negative qtyChange)
                await updateInventoryTransaction(moveState.sku, moveState.fromLocation, -qty);
                
                // Step 2: Add stock to TO location (positive qtyChange)
                await updateInventoryTransaction(moveState.sku, toLocation, qty);
                
                showMessage('move-message', `Sukses! ${qty} unit SKU ${moveState.sku} dipindahkan dari ${moveState.fromLocation} ke ${toLocation}.`, 'success');
                resetMove();
            } catch (e) {
                showMessage('move-message', `Gagal Perpindahan: ${e.message}`, 'error');
            }
        };
        
        window.resetMove = function() {
            moveState = { sku: null, fromLocation: null, toLocation: null, qty: null };
            document.getElementById('move-sku-input').value = '';
            document.getElementById('move-from-location-input').value = '';
            document.getElementById('move-to-location-input').value = '';
            document.getElementById('move-qty-input').value = '1';

            document.getElementById('move-step-3').classList.add('hidden');
            document.getElementById('move-step-2').classList.add('hidden');
            document.getElementById('move-step-1').classList.remove('hidden');
            document.getElementById('move-sku-input').focus();
        };

        window.handleMoveKeyPress = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (!document.getElementById('move-step-1').classList.contains('hidden')) {
                    startMoveStep2();
                } else if (!document.getElementById('move-step-2').classList.contains('hidden')) {
                    startMoveStep3();
                } else if (!document.getElementById('move-step-3').classList.contains('hidden')) {
                    if (document.activeElement.id === 'move-qty-input') {
                        commitMove();
                    } else if (document.activeElement.id === 'move-to-location-input') {
                        document.getElementById('move-qty-input').focus();
                    }
                }
            }
        };
        
        // ------------------ PICK ------------------

        let pickState = {
            sku: null,
            location: null,
            qty: null
        };

        window.startPickStep2 = function() {
            const skuInput = document.getElementById('pick-sku-input');
            let sku = skuInput.value.trim().toUpperCase();

            // PENGOLAHAN INPUT: Tidak perlu menghapus *
            
            if (!sku) {
                showMessage('pick-message', 'Masukkan QR Code SKU yang valid.', 'error');
                skuInput.focus();
                return;
            }
            
            // NEW VALIDATION: Check if SKU is registered in the master list
            if (!window.skuMaster[sku]) {
                 showMessage('pick-message', `SKU ${sku} belum terdaftar. Cek Registrasi SKU.`, 'error');
                 skuInput.focus();
                 return;
            }


            pickState.sku = sku;
            document.getElementById('current-pick-sku').textContent = sku;
            
            document.getElementById('pick-step-1').classList.add('hidden');
            document.getElementById('pick-step-2').classList.remove('hidden');
            document.getElementById('pick-location-input').focus();
            document.getElementById('pick-message').classList.add('hidden');
        };

        window.commitPick = async function() {
            const location = document.getElementById('pick-location-input').value.trim().toUpperCase();
            const qty = parseInt(document.getElementById('pick-qty-input').value, 10);

            if (!location || qty <= 0 || !pickState.sku) {
                showMessage('pick-message', 'Lengkapi SKU, Lokasi, dan Kuantitas (>0).', 'error');
                return;
            }

            showMessage('pick-message', 'Memproses pengambilan...', 'info');
            
            // Picking is a negative change in stock
            try {
                await updateInventoryTransaction(pickState.sku, location, -qty);
                showMessage('pick-message', `Sukses! ${qty} unit SKU ${pickState.sku} diambil dari ${location}.`, 'success');
                resetPick();
            } catch (e) {
                showMessage('pick-message', `Gagal Pengambilan: ${e.message}`, 'error');
            }
        };

        window.resetPick = function() {
            pickState = { sku: null, location: null, qty: null };
            document.getElementById('pick-sku-input').value = '';
            document.getElementById('pick-location-input').value = '';
            document.getElementById('pick-qty-input').value = '1';

            document.getElementById('pick-step-1').classList.remove('hidden');
            document.getElementById('pick-step-2').classList.add('hidden');
            document.getElementById('pick-sku-input').focus();
        };

        window.handlePickKeyPress = function(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                if (document.getElementById('pick-step-1').classList.contains('hidden')) {
                    if (document.activeElement.id === 'pick-qty-input') {
                        commitPick();
                    } else if (document.activeElement.id === 'pick-location-input') {
                        document.getElementById('pick-qty-input').focus();
                    }
                } else {
                    startPickStep2();
                }
            }
        };

        // --- UI Rendering and Navigation ---

        /**
         * Renders the search results table.
         * @param {Array<Object>} results - Array of inventory items to display.
         * @param {string} targetId - ID of the tbody element to render into.
         */
        function renderInventoryTable(results, targetId, emptyMessage) {
            const listEl = document.getElementById(targetId);
            const emptyEl = document.getElementById(emptyMessage);
            listEl.innerHTML = '';

            if (results.length === 0) {
                emptyEl.style.display = 'block';
                emptyEl.textContent = "Tidak ada data yang ditemukan.";
            } else {
                emptyEl.style.display = 'none';
            }
            
            results
                .filter(item => item.qty > 0)
                .sort((a, b) => {
                    // FIX: Melindungi dari properti yang tidak ada saat mengurutkan
                    const skuA = a.sku || '';
                    const skuB = b.sku || '';
                    const locA = a.location || '';
                    const locB = b.location || '';
                    
                    if (skuA < skuB) return -1;
                    if (skuA > skuB) return 1;
                    if (locA < locB) return -1;
                    if (locA > locB) return 1;
                    return 0;
                })
                .forEach(item => {
                    const row = document.createElement('tr');
                    row.classList.add('hover:bg-gray-50');
                    const description = window.skuMaster[item.sku || ''] ? window.skuMaster[item.sku || ''].description : 'N/A';

                    // FIX: Gunakan fallback string untuk menghindari 'undefined'
                    const displaySku = item.sku || 'SKU HILANG';
                    const displayLocation = item.location || 'LOKASI HILANG';
                    const displayDescription = description;
                    const displayQty = item.qty.toLocaleString('id-ID');
                    
                    // Format waktu untuk tampilan yang lebih singkat
                    let displayTimestamp = 'N/A';
                    if (item.updatedAt) {
                         try {
                            const date = new Date(item.updatedAt);
                            displayTimestamp = date.toLocaleString('id-ID', { 
                                year: 'numeric', 
                                month: 'short', 
                                day: 'numeric', 
                                hour: '2-digit', 
                                minute: '2-digit' 
                            });
                         } catch (e) {
                             displayTimestamp = item.updatedAt.substring(0, 10); // Fallback to date only
                         }
                    }


                    // PERBAIKAN STRUKTUR KOLOM SESUAI PERMINTAAN USER: SKU | Deskripsi | Lokasi | Jumlah | Diperbarui
                    row.innerHTML = `
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${displaySku}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${displayDescription}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${displayLocation}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm font-bold text-gray-800">${displayQty}</td>
                        <td class="px-3 py-4 whitespace-nowrap text-sm text-gray-500">${displayTimestamp}</td>
                    `;
                    listEl.appendChild(row);
                });
        }
        
        /**
         * Renders the real-time inventory list and dashboard stats.
         */
        function renderDashboard() {
            renderInventoryTable(window.inventory, 'inventory-list', 'empty-inventory');

            let totalQty = 0;
            const uniqueLocations = new Set();
            
            if (window.inventory.length > 0) {
                window.inventory
                    .filter(item => item.qty > 0)
                    .forEach(item => {
                        totalQty += item.qty;
                        uniqueLocations.add(item.location || 'UNKNOWN'); // Gunakan UNKNOWN sebagai fallback
                    });
            }

            // Update stats
            // FIX: Mengambil total SKU Unik dari window.skuMaster (Master Data)
            document.getElementById('total-sku').textContent = Object.keys(window.skuMaster).length.toLocaleString('id-ID');
            document.getElementById('total-qty').textContent = totalQty.toLocaleString('id-ID');
            document.getElementById('total-locations').textContent = uniqueLocations.size.toLocaleString('id-ID');
        }

        /**
         * Logic for client-side search based on SKU or Location.
         */
        window.searchInventory = function() {
            const query = document.getElementById('search-input').value.trim().toUpperCase();
            
            if (query.length < 2 && query.length !== 0) {
                 // Tidak perlu melakukan apa-apa jika query terlalu pendek
                 return;
            }

            const filteredResults = window.inventory.filter(item => {
                // FIX KRITIS: Menambahkan fallback string ('') untuk item.sku dan item.location
                const itemSku = item.sku || ''; 
                const itemLocation = item.location || '';

                // Karena item.sku/item.location sudah dalam uppercase (dari penyimpanan), kita tidak perlu toUpperCase() lagi.
                const skuMatch = itemSku.includes(query);
                const locationMatch = itemLocation.includes(query);
                
                // Cari juga di deskripsi SKU (jika ada)
                let descMatch = false;
                const skuData = window.skuMaster[itemSku];
                if (skuData && skuData.description) {
                    descMatch = skuData.description.toUpperCase().includes(query);
                }

                return item.qty > 0 && (skuMatch || locationMatch || descMatch);
            });

            if (query.length === 0) {
                // Tampilkan pesan default
                document.getElementById('empty-search').textContent = "Masukkan SKU, Lokasi, atau Deskripsi untuk memulai pencarian...";
            }

            // Panggil renderInventoryTable untuk menampilkan hasil
             renderInventoryTable(filteredResults, 'search-results-list', 'empty-search');
        };

        /**
         * Switches the active view/tab.
         */
        window.changeView = function(viewName) {
            window.currentView = viewName;

            // Hide all view sections
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));

            // Show the target view
            const targetView = document.getElementById(`${viewName}-view`);
            if (targetView) {
                targetView.classList.remove('hidden');
                document.title = `WMS - ${viewName.charAt(0).toUpperCase() + viewName.slice(1)}`;
            }

            // Update button styles
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const isActive = btn.onclick.toString().includes(`'${viewName}'`);
                btn.classList.toggle('bg-indigo-600', isActive);
                btn.classList.toggle('text-white', isActive);
                btn.classList.toggle('bg-gray-100', !isActive);
                btn.classList.toggle('text-gray-700', !isActive);

                // Focus on the first input of the active view
                if (isActive) {
                    setTimeout(() => {
                        const firstInput = targetView.querySelector('input[type="text"]');
                        if (firstInput) {
                            firstInput.focus();
                        }
                    }, 100);
                }
            });
        };

        // --- Application Startup ---
        window.onload = function() {
            initFirebase();
            changeView('dashboard'); // Start on the dashboard
        };

    </script>
</body>
</html>
